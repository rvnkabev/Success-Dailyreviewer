<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Success Daily Reviewer</title>
  <style>
    :root{ --bg:#0b1020; --panel:#121a33; --ink:#e9eefc; --muted:#9fb2ff; --accent:#7aa2ff; --accent2:#25d0a6; --warn:#ffb02e; --danger:#ff5a78; --ok:#21d19f; }
    html,body{height:100%;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC","Microsoft JhengHei",Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%); color:var(--ink);}
    .wrap{max-width:1100px;margin:0 auto;padding:28px;}
    h1{margin:0 0 8px;font-size:28px;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:18px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .row{display:grid;gap:16px}
    .pad{padding:18px}
    textarea{width:100%;min-height:280px;border-radius:12px;background:#0c1431;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:12px 14px;font-size:14px;line-height:1.5;}
    input[type="text"],select{width:100%;border-radius:10px;background:#0c1431;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:10px 12px;font-size:14px}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#0a0f1f;font-weight:700;cursor:pointer}
    button.secondary{background:#1b254d;color:var(--ink);border:1px solid rgba(255,255,255,.08)}
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--ink)}
    .hidden{display:none}
    .steps{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .step{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);color:var(--muted);}
    .step.active{background:var(--accent2);color:#07121c;border-color:transparent}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    table{width:100%;border-collapse:collapse;background:#0d1636;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#bcd0ff;background:#101a3e}
    code,kbd{background:#0a1231;border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;color:#cde}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0d1636}
    .pill.ok{border-color:rgba(33,209,159,.4);}
    .pill.warn{border-color:rgba(255,176,46,.45)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .muted{color:#a9b8f7}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent);margin:14px 0}
    .note{font-size:12px;color:#b7c6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Success Daily Reviewer</h1>
    <div class="sub">ä¸‰é æµç¨‹ï½œPage 1 è¼¸å…¥ â†’ Page 2 é‹å‹•ç´€éŒ„ç¢ºèªï¼ˆå¯è¦†å¯«/è£œå……è³‡æ–™ï¼‰â†’ Page 3 çµ±è¨ˆèˆ‡ç¡çœ æŒ‡æ•¸</div>

    <div class="steps">
      <div class="step" id="badge1">1. è¼¸å…¥è³‡æ–™</div>
      <div class="step" id="badge2">2. æœ‰ç„¡é‹å‹•ç´€éŒ„ï¼Ÿï¼ˆå¯è£œå……è¼¸å…¥ï¼‰</div>
      <div class="step" id="badge3">3. çµ±è¨ˆèˆ‡è¼¸å‡º</div>
    </div>

    <!-- Page 1 -->
    <section class="card pad" id="page1">
      <div class="row">
        <div>
          <h3>Page 1 â€” è²¼ä¸Šä½ çš„æ¯æ—¥ç´€éŒ„</h3>
          <p class="muted">å»ºè­°æ ¼å¼ï¼šæ¯è¡Œä¸€æ¢ç´€éŒ„ï¼Œæ—¥æœŸç½®å‰ï¼Œä¾‹å¦‚ <code>2025-09-26ï½œ#pomodoro #financeï½œâ€¦</code>ï¼›ä¹Ÿæ”¯æ´ <code>[YYYY-MM-DD]</code> å€æ®µã€‚</p>
        </div>
        <textarea id="inputText" placeholder="åœ¨æ­¤è²¼ä¸Šä½ çš„ç´€éŒ„æ–‡æœ¬â€¦"></textarea>
        <div class="grid-auto">
          <div class="pill">æ™‚å€ï¼šAsia/Tokyo</div>
          <div class="pill">æ—¥æœŸè§£æï¼š<kbd>YYYY-MM-DD</kbd> / <kbd>[YYYY-MM-DD]</kbd></div>
          <div class="pill">ç¡çœ è¦–çª—ï¼š18:00â€“05:59</div>
        </div>
        <div class="btns">
          <button id="next1">ä¸‹ä¸€æ­¥ï¼šé‹å‹•ç´€éŒ„ç¢ºèª â†’</button>
          <button class="secondary" id="demo">è¼‰å…¥ç¯„ä¾‹è³‡æ–™</button>
          <button class="ghost" id="clear">æ¸…ç©º</button>
        </div>
      </div>
    </section>

    <!-- Page 2 -->
    <section class="card pad hidden" id="page2">
      <h3>Page 2 â€” æ˜¯å¦åŒ…å«é‹å‹•ç´€éŒ„ï¼Ÿï¼ˆå¯åœ¨æ­¤è£œå……/ä¿®æ­£è¼¸å…¥ï¼‰</h3>
      <p class="muted">è¦å‰‡ï¼šåŒä¸€ <code>[YYYY-MM-DD]</code> å€æ®µå…§è‹¥å« <u>2 å€‹ä»¥ä¸Šä¸åŒéƒ¨ä½</u>ï¼ˆå¦‚ Chest èˆ‡ Swimï¼‰ï¼Œå‰‡ç•¶å¤©è¨ˆ <strong>2 æ¬¡é‹å‹•</strong>ï¼›å¦å‰‡ <strong>1 æ¬¡</strong>ã€‚æœ€è¿‘ä¸ƒå¤©ï¼ˆå«åŸºæº–æ—¥ï¼‰æ¯æ¬¡ 10 åˆ†ã€ä¸Šé™ 100 åˆ†ï¼Œä½œç‚ºã€Œå¥åº·æŒ‡æ•¸ã€ã€‚</p>
      <textarea id="inputTextPage2" placeholder="ï¼ˆå¯é¸ï¼‰åœ¨æ­¤è£œå……/è¦†å¯« Page 1 çš„è¼¸å…¥ï¼›è‹¥ç•™ç©ºå°‡æ²¿ç”¨ Page 1 æ–‡å­—ã€‚"></textarea>
      <div class="note">æç¤ºï¼šæŒ‰ä¸‹ã€Œæœ‰ï¼Œç¹¼çºŒã€æˆ–ã€Œæ²’æœ‰ä¹Ÿè¦çµ±è¨ˆã€æ™‚ï¼Œè‹¥æœ¬æ¬„æœ‰å…§å®¹ï¼Œç³»çµ±å°‡ä»¥æœ¬æ¬„å…§å®¹è¦†å¯« Page 1 çš„è³‡æ–™ã€‚</div>
      <div class="btns" style="margin-top:10px">
        <button id="confirmHasWorkout">æœ‰ï¼Œç¹¼çºŒ â†’</button>
        <button class="secondary" id="confirmNoWorkout">æ²’æœ‰ä¹Ÿè¦çµ±è¨ˆï¼ˆè¦–ç‚º 0 æ¬¡ï¼‰ â†’</button>
        <button class="ghost" id="back1">â† è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </section>

    <!-- Page 3 -->
    <section class="card pad hidden" id="page3">
      <div class="grid-2">
        <div>
          <h3>Page 3 â€” å…­é¡è©•åˆ†è¡¨ï¼ˆå›ºå®šæ ¼å¼ï¼‰</h3>
          <div id="scoreTableWrap"></div>
          <div class="hr"></div>
          <div class="btns">
            <button id="copyTable">è¤‡è£½è©•åˆ†è¡¨</button>
            <button class="secondary" id="recalc">é‡æ–°è¨ˆç®—</button>
            <button class="ghost" id="back2">â† è¿”å›ä¸Šä¸€æ­¥</button>
          </div>
          <div id="alertBox" class="muted" style="margin-top:10px"></div>
        </div>
        <div>
          <h3>ç¡çœ æŒ‡æ•¸ï¼ˆå¼·åŒ–ç‰ˆï¼‰</h3>
          <div class="muted" style="margin-bottom:8px">ä»¥è¼¸å…¥æ–‡æœ¬çš„æœ€å¤§æ—¥æœŸç‚º Dmaxï¼Œåˆ†æå€é–“ç‚º <code>Dmax-6 â€¦ Dmax</code>ã€‚è§£æï¼šä¸ŠåºŠæ™‚é–“ã€ç¡çœ æ™‚æ•¸ã€ç²¾ç¥æŒ‡æ•¸ã€‚æ”¯æ´ <code>sleep=</code>ã€<code>onBed=</code>ã€<code>energy=</code> æ ¼å¼ã€‚</div>
          <div id="sleepSummary" class="pad" style="background:#0d1636;border-radius:12px;border:1px solid rgba(255,255,255,.08)"></div>
          <div class="hr"></div>
          <h4>ğŸ§ª ç¡çœ è‡ªæˆ‘é©—è­‰</h4>
          <pre id="sleepAudit" class="mono" style="white-space:pre-wrap;background:#0a1231;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px;max-height:360px;overflow:auto"></pre>
          <div class="btns">
            <button id="copySleep">è¤‡è£½ç¡çœ å€å¡Š</button>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===== Helpers ===== */
const $ = (q)=>document.querySelector(q);
function setStep(n){
  [1,2,3].forEach(i=>$('#badge'+i).classList.toggle('active', i===n));
  ['#page1','#page2','#page3'].forEach((id,idx)=>{
    const el = document.querySelector(id);
    if(idx===n-1) el.classList.remove('hidden'); else el.classList.add('hidden');
  });
}
function toHalfWidth(str){
  return str.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/ã€€/g, ' ');
}
function normalizeText(s){
  return toHalfWidth(s).replace(/[|:\uFF5C\uFF1A]/g,'ï½œ').toLowerCase();
}
function uniq(arr){ return Array.from(new Set(arr)); }
function pad2(n){return (n<10?'0':'')+n;}
const DATE_RE = /\b(\d{4})-(\d{2})-(\d{2})\b/;
const DATE_BRACKET_RE = /\[(\d{4})-(\d{2})-(\d{2})\]/;
function parseYMD(s){
  const m = s.match(DATE_RE); if(!m) return null; const y=+m[1],mo=+m[2]-1,d=+m[3];
  const dt = new Date(y,mo,d);
  if(dt.getFullYear()!==y||dt.getMonth()!==mo||dt.getDate()!==d) return null;
  return dt;
}
function ymd(dt){return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate());}
function addDays(dt,delta){const t=new Date(dt); t.setDate(t.getDate()+delta); return t;}
let lastFingerprint = null;
function makeFingerprint(text){
  const L = text.split(/\n/).length;
  const C = [...text].length;
  let sum=0; for(const ch of text){ sum += ch.codePointAt(0)||0; }
  const H = sum % 10000;
  return {L,C,H};
}
function hashString(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h + s.charCodeAt(i))|0; } return (h>>>0).toString(16); }

/* ===== Sections ===== */
function buildSections(raw){
  const lines = normalizeText(raw).split(/\n/);
  const sections = []; // [{date:'yyyy-mm-dd', lines:[...]}]
  let current = null;
  for(const rawLine of lines){
    const line = rawLine.trim(); if(!line) continue;
    const bh = line.match(DATE_BRACKET_RE);
    if(bh){ current = {date:`${bh[1]}-${bh[2]}-${bh[3]}`, lines:[]}; sections.push(current); continue; }
    const hd = line.match(/^\b(\d{4})-(\d{2})-(\d{2})\b/);
    if(hd){ current = {date:`${hd[1]}-${hd[2]}-${hd[3]}`, lines:[line]}; sections.push(current); continue; }
    if(!current){ continue; }
    current.lines.push(line);
  }
  return sections;
}

/* ===== Health Index & Categories ===== */
function computeHealthIndex(text){
  const sections = buildSections(text);
  if(!sections.length) return {score:0,count:0,window:[],dmax:null, detail:[]};
  // Dmax & 7-day window
  let dmax = null; for(const s of sections){ const dt=parseYMD(s.date); if(dt && (!dmax || dt>dmax)) dmax=dt; }
  const window = []; for(let i=6;i>=0;i--) window.push(ymd(addDays(dmax,-i)));
  // parts per date
  const partKeywords = ['chest','back','shoulder','leg','legs','arm','biceps','triceps','swim','run','cardio','yoga','bike','cycling','row','core','abs','squat','deadlift','bench','press','climb','boulder','hike','walk'];
  const dayMap = new Map();
  for(const s of sections){
    if(!window.includes(s.date)) continue;
    const set = dayMap.get(s.date) || new Set();
    for(const line of s.lines){ for(const p of partKeywords){ if(line.includes(p)) set.add(p); } }
    dayMap.set(s.date,set);
  }
  let count=0; const detail=[];
  for(const d of window){
    const set = dayMap.get(d) || new Set();
    const times = set.size>=2?2:(set.size>=1?1:0);
    count+=times; detail.push({date:d,parts:[...set],times});
  }
  const score = Math.min(100, count*10);
  return {score,count,window,dmax,detail};
}

const CATEGORY_DEFS = [
  {key:'å¥åº·æŒ‡æ•¸', kind:'health'},
  {key:'å­¸ç¿’è²¡ç¶“', re:/(?=.*#pomodoro)(?=.*#finance)/i},
  {key:'å­¸ç¿’è‹±æ–‡', re:/(?=.*#pomodoro)(?=.*#english)/i},
  {key:'åæ€æ•´ç†', re:/(?=.*#pomodoro)(?=.*#review)/i},
  {key:'è‡ªæˆ‘è¦ºå¯Ÿ', re:/(?=.*#mentalhealth)(?=.*#selfcontrol)/i},
  {key:'é—œä¿‚ç¶“ç‡Ÿ', re:/(?=.*#relationship)(?=.*#happywifehappylife)/i}
];

function computeCategories(text, healthScore){
  const lines = normalizeText(text).split(/\n/).map(s=>s.trim()).filter(Boolean);
  const counts = new Map(CATEGORY_DEFS.map(c=>[c.key,0]));
  for(const line of uniq(lines)){
    for(const c of CATEGORY_DEFS){ if(c.kind==='health') continue; if(c.re.test(line)) counts.set(c.key, counts.get(c.key)+1); }
  }
  return CATEGORY_DEFS.map(c=>{
    if(c.kind==='health') return {key:c.key, times:Math.round(healthScore/10), score:healthScore};
    const times = counts.get(c.key) || 0; return {key:c.key, times, score:Math.min(100, times*10)};
  });
}

/* ===== Sleep Parsing (å¼·åŒ–ç‰ˆï¼škey=value) ===== */
const TIME24 = /\b(?:[01]?\d|2[0-3])[:ï¼š][0-5]\d\b/;
const TIME12 = /\b(1[0-2]|0?[1-9])\s?(am|pm)\b/;
const TIME_CN_DAWN = /å‡Œæ™¨\s*([0-5]?\d)(?:[:ï¼š]([0-5]\d))?/;
const BED_KW = /(ä¸ŠåºŠ|å°±å¯¢|å…¥ç¡|ç¡è¦ºé–‹å§‹|sleep\s*start|bedtime|onbed|sleep_start|sleepstart)/i;
const BED_EQ = /(onbed|bedtime|sleep_start|sleepstart|ä¸ŠåºŠ|å°±å¯¢|å…¥ç¡)\s*[:=]\s*([^ï½œ\s]+)/i; // e.g., onBed=11:59pm
const DUR_FLOAT = /\b(\d+(?:\.\d+)?)\s*(h|å°æ™‚)\b/i;
const DUR_HM = /\b(\d+)\s*(?:h|å°æ™‚)\s*(\d+)\s*(?:m|åˆ†)\b/i;
const DUR_HHMM = /\b([0-1]?\d|2[0-3])[:ï¼š]([0-5]\d)\b/; // when context says duration
const DUR_EQ = /(sleep|slept|duration|ç¡äº†|ç¡çœ æ™‚æ•¸)\s*[:=]\s*([^ï½œ\s]+)/i; // e.g., sleep=9h
const DUR_MIN = /\b(\d+)\s*(min|åˆ†é˜)\b/i;
const ENERGY = /(ç²¾ç¥(?:æŒ‡æ•¸)?|energy)\s*[:ï¼š=]?\s*(\d+(?:\.\d+)?)\s*(?:\/\s*10|\/10|åˆ†)?/i;

function tryExtractBedTime(line){
  let m = line.match(BED_EQ);
  if(m){ return m[2]; }
  if(!BED_KW.test(line)) return null;
  m = line.match(TIME24); if(m) return m[0];
  m = line.match(TIME12); if(m) return `${m[1]}${m[2]}`;
  m = line.match(TIME_CN_DAWN);
  if(m){ const hh = (m[1]+'').padStart(2,'0'); const mm = (m[2]||'00').padStart(2,'0'); return `${hh}:${mm}`; }
  return null;
}
function parseBedToMinutes(s){
  let minutes=null;
  if(/am|pm/.test(s)){
    const mt = s.match(/(\d{1,2})(?::(\d{2}))?(am|pm)/);
    if(mt){ let h=(+mt[1])%12; if(mt[3]==='pm') h+=12; const mm = mt[2]? +mt[2] : 0; minutes=h*60+mm; }
  }else{
    const mt = s.match(/(\d{1,2}):(\d{2})/); if(mt){ minutes= (+mt[1])*60 + (+mt[2]); }
  }
  if(minutes==null) return null;
  if(minutes<720) minutes += 1440; // <12:00 è¦–ç‚º +24h
  const ok = (minutes>=1080 && minutes<= (5*60+59)+1440); // 18:00â€“05:59
  return ok ? minutes%1440 : null;
}
function parseDurationToken(tok){
  let m = tok.match(DUR_HM); if(m) return (+m[1]) + (+m[2])/60;
  m = tok.match(DUR_FLOAT); if(m) return +m[1];
  m = tok.match(DUR_HHMM); if(m) return (+m[1]) + (+m[2])/60;
  m = tok.match(DUR_MIN); if(m) return (+m[1])/60;
  return null;
}
function tryExtractDurationHours(line){
  let m = line.match(DUR_EQ); if(m){ const v = parseDurationToken(m[2]); if(v!=null) return v; }
  m = line.match(DUR_HM); if(m) return (+m[1]) + (+m[2])/60;
  m = line.match(DUR_FLOAT); if(m) return +m[1];
  if(/ç¡äº†|duration/i.test(line)){ m = line.match(DUR_HHMM); if(m) return (+m[1]) + (+m[2])/60; }
  m = line.match(DUR_MIN); if(m) return (+m[1])/60;
  return null;
}
function tryExtractEnergy(line){
  const m = line.match(ENERGY); return m ? +m[2] : null;
}

function computeSleep(text){
  const sections = buildSections(text);
  if(!sections.length){ return {summary:"ï¼ˆæ‰¾ä¸åˆ°æ—¥æœŸï¼Œç„¡æ³•è¨ˆç®—ç¡çœ å€é–“ï¼‰", audit:"", hash:""}; }
  // Dmax & window
  let dmax = null; for(const s of sections){ const dt=parseYMD(s.date); if(dt && (!dmax || dt>dmax)) dmax=dt; }
  const winSet = new Set(); for(let i=6;i>=0;i--) winSet.add( ymd(addDays(dmax,-i)) );

  const rows=[]; const excluded=[];
  for(const s of sections){
    if(!winSet.has(s.date)) continue;
    for(const ln of uniq(s.lines)){
      const bedStr = tryExtractBedTime(ln);
      const dur = tryExtractDurationHours(ln);
      const eng = tryExtractEnergy(ln);
      let bedMin = null; if(bedStr) bedMin = parseBedToMinutes(bedStr);
      const rec = {date:s.date, src:ln.slice(0,100), bed:bedMin, bedRaw:bedStr, dur:dur, eng:eng};

      let ok=true; const reasons=[];
      if(bedStr && bedMin==null){ ok=false; reasons.push('ä¸ŠåºŠæ™‚é–“è¶…å‡º 18:00â€“05:59 è¦å‰‡'); }
      if(dur!=null && (dur<2 || dur>14)){ ok=false; reasons.push('ç¡çœ æ™‚æ•¸è¶…ç•Œ (2â€“14h)'); }
      if(eng!=null && (eng<0 || eng>10)){ ok=false; reasons.push('ç²¾ç¥æŒ‡æ•¸è¶…ç•Œ (0â€“10)'); }

      if(ok && (bedStr || dur!=null || eng!=null)) rows.push(rec);
      else if(!ok) excluded.push({date:s.date, src:rec.src, reason:reasons.join('ã€')});
    }
  }

  const beds = rows.filter(r=>r.bed!=null).map(r=>r.bed);
  const durs = rows.filter(r=>r.dur!=null).map(r=>r.dur);
  const engs = rows.filter(r=>r.eng!=null).map(r=>r.eng);
  const avg = a => a.length? a.reduce((x,y)=>x+y,0)/a.length : null;
  const avgBed = avg(beds), avgDur = avg(durs), avgEng = avg(engs);

  const bedTo12 = m => {
    if(m==null) return 'â€”';
    let h=Math.floor(m/60), mm=m%60; const ap = h>=12? 'pm':'am'; h = h%12; if(h===0) h=12;
    return `${h}:${pad2(mm)}${ap}`;
  };

  const formula = [
    'ã€è¨ˆç®—å…¬å¼ã€‘',
    'â€¢ å¹³å‡ä¸ŠåºŠæ™‚é–“ï¼šå°‡ä¸ŠåºŠæ™‚é–“æ˜ å°„è‡³ 18:00â€“05:59 è¦–çª—ï¼ˆ<12:00 åŠ  24hï¼‰ï¼Œå–å¹³å‡å¾Œå†è½‰å› 12h æ¨£å¼ã€‚',
    'â€¢ å¹³å‡ç¡çœ æ™‚æ•¸ï¼šæœ‰æ•ˆæ¨£æœ¬ï¼ˆ2â€“14hï¼‰ä¹‹ç®—è¡“å¹³å‡ï¼Œå››æ¨äº”å…¥è‡³å°æ•¸ç¬¬ 2 ä½ã€‚',
    'â€¢ å¹³å‡ç²¾ç¥æŒ‡æ•¸ï¼šæœ‰æ•ˆæ¨£æœ¬ï¼ˆ0â€“10ï¼‰ä¹‹ç®—è¡“å¹³å‡ï¼Œå››æ¨äº”å…¥è‡³å°æ•¸ç¬¬ 2 ä½ã€‚'
  ].join('\n');

  const summary = [
    'ğŸ§¾ çµè«–æ•´ç†',
    `ğŸ›ï¸ å¹³å‡ä¸ŠåºŠæ™‚é–“ï¼š${bedTo12(avgBed)}`,
    `ğŸ˜´ å¹³å‡ç¡çœ æ™‚æ•¸ï¼š${avgDur!=null?avgDur.toFixed(2):'â€”'} å°æ™‚`,
    `âš¡ å¹³å‡ç²¾ç¥æŒ‡æ•¸ï¼š${avgEng!=null?avgEng.toFixed(2):'â€”'} / 10`,
    '',
    formula
  ].join('\n');

  const linesAudit = rows.map(r=>`- ${r.date}ï½œâ€¦${r.src}â€¦ï½œä¸ŠåºŠ ${r.bedRaw?bedTo12(r.bed):'â€”'}ï½œæ™‚æ•¸ ${r.dur!=null?r.dur.toFixed(2)+'h':'â€”'}ï½œç²¾ç¥ ${r.eng!=null?(r.eng%1? r.eng.toFixed(2):r.eng)+'/10':'â€”'}`);
  const stat = `\n\nâœ… çµ±è¨ˆï¼šä¸ŠåºŠ ${beds.length} ç­†ï½œæ™‚æ•¸ ${durs.length} ç­†ï½œç²¾ç¥ ${engs.length} ç­†`+
               `\nâ†’ å¹³å‡ä¸ŠåºŠï¼š${bedTo12(avgBed)}`+
               `\nâ†’ å¹³å‡æ™‚æ•¸ï¼š${avgDur!=null?avgDur.toFixed(2):'â€”'} h`+
               `\nâ†’ å¹³å‡ç²¾ç¥ï¼š${avgEng!=null?avgEng.toFixed(2):'â€”'} / 10`;
  const excl = excluded.length? ('\n\nğŸš« æ’é™¤æ¸…å–®ï¼š\n' + excluded.map(e=>`- ${e.date}ï½œâ€¦${e.src}â€¦ï½œ${e.reason}`).join('\n')) : '';

  const hash = hashString(summary+"|"+linesAudit.join('\n')+stat+excl);
  const audit = ['ãƒ»å‘½ä¸­æ¢åˆ—ï¼ˆä¸ŠåºŠ/æ™‚æ•¸/ç²¾ç¥ï¼‰ï¼š', ...linesAudit].join('\n') + stat + excl;

  return {summary, audit, hash};
}

/* ===== Rendering ===== */
function renderFixedTable(rows){
  const map = new Map(rows.map(r=>[r.key,r]));
  const rowHTML = k => { const r = map.get(k) || {times:0,score:0}; return `<tr><td>${k}</td><td>${r.times} æ¬¡</td><td>${r.score} åˆ†</td></tr>`; };
  return `
  <table>
    <thead><tr><th>é¡åˆ¥</th><th>å‡ºç¾æ¬¡æ•¸</th><th>ç¸½åˆ†</th></tr></thead>
    <tbody>
      ${rowHTML('å¥åº·æŒ‡æ•¸')}
      ${rowHTML('å­¸ç¿’è²¡ç¶“')}
      ${rowHTML('å­¸ç¿’è‹±æ–‡')}
      ${rowHTML('åæ€æ•´ç†')}
      ${rowHTML('è‡ªæˆ‘è¦ºå¯Ÿ')}
      ${rowHTML('é—œä¿‚ç¶“ç‡Ÿ')}
    </tbody>
  </table>`;
}

function doAll(){
  const raw = $('#inputText').value||'';

  // å¥åº·æŒ‡æ•¸
  const health = computeHealthIndex(raw);
  const categories = computeCategories(raw, health.score);
  const tableHTML = renderFixedTable(categories);
  document.getElementById('scoreTableWrap').innerHTML = tableHTML +
    `<div style="margin-top:8px" class="muted">å¥åº·æŒ‡æ•¸ï¼šæœ€è¿‘ä¸ƒå¤©ï¼ˆ${health.window.join('ã€')}ï¼‰å…± <b>${health.count}</b> æ¬¡é‹å‹• â†’ ${health.score} åˆ†ã€‚` +
    (health.dmax?`ï¼ˆDmax=${ymd(health.dmax)}ï¼‰`:'') + `</div>`;

  // ç¡çœ 
  const sleep = computeSleep(raw);
  document.getElementById('sleepSummary').textContent = sleep.summary;
  document.getElementById('sleepAudit').textContent = sleep.audit +
    `\n\nğŸ”’ Fingerprint | L=${makeFingerprint(raw).L}, C=${makeFingerprint(raw).C}, H=${makeFingerprint(raw).H}`;

  // ä¸€è‡´æ€§è­¦å‘Š
  const fp = makeFingerprint(raw);
  const cur = {L:fp.L,C:fp.C,H:fp.H, tableHash:hashString(tableHTML), sleepHash:sleep.hash};
  let alertMsg = '';
  if(lastFingerprint && lastFingerprint.L===cur.L && lastFingerprint.C===cur.C && lastFingerprint.H===cur.H){
    if(lastFingerprint.tableHash!==cur.tableHash || lastFingerprint.sleepHash!==cur.sleepHash){
      alertMsg = 'âš ï¸ åµæ¸¬åˆ°çµæœä¸ä¸€è‡´ï¼šè«‹æª¢æŸ¥æ˜¯å¦æœ‰åˆ¤æ–·é‚è¼¯æˆ–çµ±è¨ˆç•°å‹•ï¼Œæˆ–æ¨™è¨˜é †åºå°è‡´éºæ¼ã€‚';
    }
  }
  lastFingerprint = cur;
  document.getElementById('alertBox').textContent = alertMsg;
}

/* ===== Events ===== */
document.getElementById('next1').addEventListener('click',()=>{
  if(!document.getElementById('inputText').value.trim()){ alert('è«‹å…ˆè²¼ä¸Šè³‡æ–™'); return; }
  setStep(2); document.getElementById('inputTextPage2').value='';
});
document.getElementById('back1').addEventListener('click',()=>setStep(1));

function applyPage2IfAny(){
  const v = document.getElementById('inputTextPage2').value.trim();
  if(v){ document.getElementById('inputText').value = v; }
}
document.getElementById('confirmHasWorkout').addEventListener('click',()=>{ applyPage2IfAny(); setStep(3); doAll(); });
document.getElementById('confirmNoWorkout').addEventListener('click',()=>{ applyPage2IfAny(); setStep(3); doAll(); });

document.getElementById('recalc').addEventListener('click',()=>doAll());
document.getElementById('back2').addEventListener('click',()=>setStep(2));
document.getElementById('copyTable').addEventListener('click',()=>{
  const node = document.getElementById('scoreTableWrap');
  const txt = node.innerText.replace(/\n{2,}/g,'\n');
  navigator.clipboard.writeText(txt).then(()=>{ alert('å·²è¤‡è£½è©•åˆ†è¡¨è‡³å‰ªè²¼ç°¿'); });
});
document.getElementById('copySleep').addEventListener('click',()=>{
  const block = 'ğŸ§¾ çµè«–æ•´ç†\n' + document.getElementById('sleepSummary').innerText +
                '\n\nğŸ§ª ç¡çœ è‡ªæˆ‘é©—è­‰\n' + document.getElementById('sleepAudit').innerText;
  navigator.clipboard.writeText(block).then(()=>alert('å·²è¤‡è£½ç¡çœ å€å¡Š'));
});
document.getElementById('clear').addEventListener('click',()=>{ document.getElementById('inputText').value=''; lastFingerprint=null; });

document.getElementById('demo').addEventListener('click',()=>{
  const demo = `
[2025-09-26]
10:31am ï½œ sleep=9h | onBed=11:59pm | energy=8/10 #health

[2025-09-25]
2025-09-25ï½œ#pomodoro #financeï½œç•« EV æ±ºç­–æ¨¹ 40m
walk 7k steps | onBed=0:05am | sleep=6h | energy=5/10

[2025-09-24]
#relationship #happywifehappylifeï½œæ™šé¤ç´„æœƒ
back row machineï½œsleep start 23:55ï½œç¡çœ æ™‚æ•¸ 7.2 å°æ™‚ï½œç²¾ç¥ 7/10

[2025-09-23]
#mentalhealth #selfcontrolï½œå†¥æƒ³ 10m
run 5kï½œä¸ŠåºŠ å‡Œæ™¨ 0:30ï½œç¡äº† 6h 30mï½œenergy 6/10

[2025-09-22]
#pomodoro #reviewï½œæ•´ç†æˆåŠŸæ—¥è¨˜ 25mï½œå…¥ç¡ 0:15ï½œç¡çœ æ™‚æ•¸ 6.5hï½œç²¾ç¥æŒ‡æ•¸ 5/10

[2025-09-21]
#pomodoro #englishï½œshadowing 20m
swim 1kmï½œduration 01:10ï½œenergy 7/10ï½œä¸ŠåºŠ 12:10am

[2025-09-20]
#pomodoro #financeï½œé–±è®€ã€Šæ¼«æ­¥è¯çˆ¾è¡—ã€‹30m
chest smith press 90kg x 10ï½œç¡äº† 6hï½œç²¾ç¥ 6/10
`;
  document.getElementById('inputText').value = demo.trim();
});

setStep(1);
</script>
</body>
</html>
