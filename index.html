<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Success Daily Reviewer â€” Sleep V2</title>
  <style>
    :root{ --bg:#0b1020; --panel:#121a33; --ink:#e9eefc; --muted:#9fb2ff; --accent:#7aa2ff; --accent2:#25d0a6; --warn:#ffb02e; --danger:#ff5a78; --ok:#21d19f; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC","Microsoft JhengHei",Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    h1{margin:0 0 8px;font-size:28px;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:18px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:grid;gap:16px}
    .pad{padding:18px}
    textarea{width:100%;min-height:280px;border-radius:12px;background:#0c1431;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:12px 14px;font-size:14px;line-height:1.5}
    input[type="text"],select{width:100%;border-radius:10px;background:#0c1431;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:10px 12px;font-size:14px}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#0a0f1f;font-weight:700;cursor:pointer}
    button.secondary{background:#1b254d;color:var(--ink);border:1px solid rgba(255,255,255,.08)}
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--ink)}
    .hidden{display:none}
    .steps{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .step{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);color:var(--muted)}
    .step.active{background:var(--accent2);color:#07121c;border-color:transparent}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    table{width:100%;border-collapse:collapse;background:#0d1636;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#bcd0ff;background:#101a3e}
    code,kbd{background:#0a1231;border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;color:#cde}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0d1636}
    .tiny{font-size:12px;color:#9fb2ff}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent);margin:14px 0}
    pre.audit{white-space:pre-wrap;background:#0a1231;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px;max-height:320px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Success Daily Reviewer</h1>
    <div class="sub">ä¸‰é æµç¨‹ï½œPage 1 è¼¸å…¥ â†’ Page 2 é‹å‹•ç´€éŒ„ â†’ Page 3 çµ±è¨ˆèˆ‡è¼¸å‡ºï¼ˆå« Sleep V2ï¼‰</div>

    <div class="steps">
      <div class="step" id="badge1">1. è¼¸å…¥è³‡æ–™</div>
      <div class="step" id="badge2">2. é‹å‹•ç´€éŒ„ï¼ˆåƒ…æ­¤é ç”¨æ–¼å¥åº·æŒ‡æ•¸ï¼‰</div>
      <div class="step" id="badge3">3. çµ±è¨ˆèˆ‡è¼¸å‡º</div>
    </div>

    <!-- Page 1 -->
    <section class="card pad" id="page1">
      <div class="row">
        <div>
          <h3>Page 1 â€” è²¼ä¸Šä½ çš„æ¯æ—¥ç´€éŒ„ï¼ˆä¾›åˆ†é¡èˆ‡ Sleep V2 ä½¿ç”¨ï¼‰</h3>
          <p class="muted">å»ºè­°æ ¼å¼ï¼šæ¯è¡Œä¸€æ¢ç´€éŒ„ï¼Œæˆ–ä»¥ <code>[YYYY-MM-DD ...]</code> åŒ…è£¹ã€‚Sleep V2 çš„å°ˆç”¨æ ¼å¼è¦‹ Page 3 èªªæ˜ã€‚</p>
        </div>
        <textarea id="inputText" placeholder="åœ¨æ­¤è²¼ä¸Šä½ çš„ç´€éŒ„æ–‡æœ¬â€¦"></textarea>
        <div class="grid-auto">
          <div class="pill">æ™‚å€ï¼šAsia/Tokyo</div>
          <div class="pill">æ—¥æœŸè§£æï¼š<kbd>YYYY-MM-DD</kbd> / <kbd>[YYYY-MM-DD]</kbd></div>
        </div>
        <div class="btns">
          <button id="next1">ä¸‹ä¸€æ­¥ï¼šé‹å‹•ç´€éŒ„ â†’</button>
          <button class="secondary" id="demo">è¼‰å…¥ç¯„ä¾‹è³‡æ–™</button>
          <button class="ghost" id="clear">æ¸…ç©º</button>
        </div>
      </div>
    </section>

    <!-- Page 2 -->
    <section class="card pad hidden" id="page2">
      <h3>Page 2 â€” é‹å‹•ç´€éŒ„ï¼ˆåƒ…æ­¤é ç”¨æ–¼ã€Œå¥åº·æŒ‡æ•¸ã€è¨ˆç®—ï¼‰</h3>
      <p class="muted">è¦å‰‡ï¼šåŒä¸€ <code>[YYYY-MM-DD]</code> å€æ®µï¼ˆæˆ–åŒæ—¥è¡Œé¦–æ—¥æœŸï¼‰è‹¥å« 2 å€‹ä»¥ä¸Šä¸åŒéƒ¨ä½ï¼ˆå¦‚ Chest èˆ‡ Swimï¼‰ï¼Œå‰‡ç•¶å¤©è¨ˆ <strong>2 æ¬¡é‹å‹•</strong>ï¼›å¦å‰‡ <strong>1 æ¬¡</strong>ã€‚æœ€è¿‘ä¸ƒå¤©ï¼ˆå«åŸºæº–æ—¥ï¼‰æ¯æ¬¡ 10 åˆ†ã€ä¸Šé™ 100 åˆ†ã€‚æ”¯æ´ <code>[YYYY-MM-DD]</code>ã€<code>YYYY-MM-DD</code>ï¼ˆè¡Œé¦–ï¼‰èˆ‡ <code>YYYY/M/D</code>ï¼ˆè¡Œé¦–ï¼‰ã€‚</p>
      <textarea id="inputTextPage2" placeholder="ï¼ˆåƒ…æ­¤è™•æ–‡å­—æœƒç”¨ä¾†ç®—å¥åº·æŒ‡æ•¸ï¼‰ä¾‹å¦‚ï¼š
[2025-06-10] chest
2025/6/10, Chest, Middle Chest, smith Machine, 80kg, 13 reps, 1 sets,
2025/6/10, Swim, Pool, 100m"></textarea>
      <div class="tiny">æç¤ºï¼šPage 1 ç”¨æ–¼åˆ†é¡èˆ‡ Sleep V2ï¼›å¥åº·æŒ‡æ•¸åªä¾†è‡ª Page 2ã€‚</div>
      <div class="btns" style="margin-top:10px">
        <button id="confirmHasWorkout">è¨ˆç®— â†’</button>
        <button class="secondary" id="confirmNoWorkout">æ²’æœ‰ç´€éŒ„ä¹Ÿè¦çµ±è¨ˆï¼ˆå¥åº·æŒ‡æ•¸å°‡ç‚º 0ï¼‰ â†’</button>
        <button class="ghost" id="back1">â† è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </section>

    <!-- Page 3 -->
    <section class="card pad hidden" id="page3">
      <div>
        <h3>Page 3 â€” å…­é¡è©•åˆ†è¡¨ï¼ˆå›ºå®šæ ¼å¼ï¼‰</h3>
        <div id="scoreTableWrap"></div>
        <div class="hr"></div>
        <div class="btns">
          <button id="copyTable">è¤‡è£½è©•åˆ†è¡¨</button>
          <button class="secondary" id="recalc">é‡æ–°è¨ˆç®—</button>
          <button class="ghost" id="back2">â† è¿”å›ä¸Šä¸€æ­¥</button>
        </div>
        <div id="alertBox" class="muted" style="margin-top:10px"></div>
      </div>

      <div class="hr"></div>
      <h3>ç¡çœ æŒ‡æ•¸ï¼ˆç°¡åŒ–è¼¸å…¥ / Sleep V2ï¼‰</h3>
      <div class="tiny">è¼¸å…¥æ ¼å¼ï¼ˆåƒ…çµ±è¨ˆæœ€è¿‘ 7 å¤©ï¼Œä¾ <code>Dmax-6 â€¦ Dmax</code> è¦–çª—ï¼‰ï¼š<br><code>[YYYY-MM-DD\nHH:MMam/pm ï½œ sleep=9h | onBed=1:00am | energy=8/10 #health]</code></div>
      <div id="sleepV2Summary" class="pad" style="background:#0d1636;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-top:8px"></div>
      <pre id="sleepV2Audit" class="audit mono"></pre>
      <div class="btns"><button id="copySleepV2">è¤‡è£½ç¡çœ å€å¡Š</button></div>

      <div class="hr"></div>
      <h3>ğŸ§ª é‹å‹•è‡ªæˆ‘é©—è­‰</h3>
      <div class="tiny">åˆ—å‡ºæœ€è¿‘ä¸ƒå¤©æ¯ä¸€æ—¥åµæ¸¬åˆ°çš„éƒ¨ä½é—œéµå­—èˆ‡ç•¶æ—¥è¨ˆæ¬¡ï¼ˆ1 æˆ– 2ï¼‰ã€‚</div>
      <pre id="exerciseAudit" class="audit mono"></pre>

      <details class="test">
        <summary>ğŸ§ª è‡ªå‹•åŒ–æ¸¬è©¦ï¼ˆé»æˆ‘å±•é–‹ / æ”¶åˆï¼‰</summary>
        <div class="muted" style="margin:8px 0">é€™äº›æ¸¬è©¦ä¸æœƒæ›´æ”¹ä½ çš„è³‡æ–™ï¼Œåƒ…ç”¨å…§å»ºå­—ä¸²é©—è­‰è¨ˆç®—é‚è¼¯ã€‚</div>
        <div class="btns"><button id="runTests">Run Tests</button></div>
        <pre id="testOut" class="mono" style="white-space:pre-wrap"></pre>
      </details>
    </section>

  </div>

<script>
/*****************
 * Helpers
 *****************/
const $ = (q)=>document.querySelector(q);
function setStep(n){
  [1,2,3].forEach(i=>$('#badge'+i).classList.toggle('active', i===n));
  ['#page1','#page2','#page3'].forEach((id,idx)=>{
    const el = document.querySelector(id);
    if(idx===n-1) el.classList.remove('hidden'); else el.classList.add('hidden');
  });
}
function toHalfWidth(str){
  return str.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/ã€€/g, ' ');
}
function normalizeText(s){ return toHalfWidth(s).replace(/[|:\uFF5C\uFF1A]/g,'ï½œ').toLowerCase(); }
function uniq(arr){ return Array.from(new Set(arr)); }
function pad2(n){ return (n<10?'0':'')+n; }

/*****************
 * Parsing Dates
 *****************/
const DATE_RE = /\b(\d{4})-(\d{2})-(\d{2})\b/;
const DATE_SLASH_HEAD = /^\b(\d{4})\/(\d{1,2})\/(\d{1,2})\b/; // YYYY/M/D at line start
function parseYMD(s){ const m = s.match(DATE_RE); if(!m) return null; const y=+m[1],mo=+m[2]-1,d=+m[3]; const dt = new Date(y,mo,d); if(dt.getFullYear()!==y||dt.getMonth()!==mo||dt.getDate()!==d) return null; return dt; }
function ymd(dt){ return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate()); }
function addDays(dt,delta){ const t=new Date(dt); t.setDate(t.getDate()+delta); return t; }

/*****************
 * Fingerprint
 *****************/
let lastFingerprint = null;
function makeFingerprint(text){ const L = text.split(/\n/).length; const C = [...text].length; let sum=0; for(const ch of text){ sum += ch.codePointAt(0)||0; } const H = sum % 10000; return {L,C,H}; }
function hashString(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h + s.charCodeAt(i))|0; } return (h>>>0).toString(16); }

/*****************
 * Exercise detection
 *****************/
const PART_PATTERNS = [
  {key:'chest', re:/(\bchest\b|bench(\s|-)press|incline\s+bench|push[- ]?up|èƒ¸(?=\s|\p{P}|$)|èƒ¸æ¨|è‡¥æ¨)/iu},
  {key:'back', re:/(\bback\b|row(\s|-)machine|lat\s+pull(-| )?down|åˆ’èˆ¹|å¼•é«”å‘ä¸Š|èƒŒ(?=\s|\p{P}|$))/iu},
  {key:'shoulder', re:/(shoulder|overhead\s+press|å´å¹³èˆ‰|è‚©|è‚©æ¨)/iu},
  {key:'legs', re:/(\bleg(s)?\b|squat|deadlift|lunge|è…¿|æ·±è¹²|ç¡¬èˆ‰|ç®­æ­¥)/iu},
  {key:'arms', re:/(biceps?|triceps?|curl|è‡‚|äºŒé ­|ä¸‰é ­)/iu},
  {key:'core', re:/(core|abs|plank|ä»°è‡¥èµ·å|æ ¸å¿ƒ)/iu},
  {key:'swim', re:/(\bswim\b|æ¸¸æ³³)/iu},
  {key:'run', re:/(\brun(ning)?\b|\b5k\b|10k|åŠé¦¬|å…¨é¦¬|è·‘æ­¥)/iu},
  {key:'walk', re:/(\bwalk(ing)?\b|æ­¥è¡Œ|å¥èµ°|\d+\s?k\s?steps)/iu},
  {key:'bike', re:/(bike|cycling|spinning|é¨è»Š|å–®è»Š|é£›è¼ª)/iu},
  {key:'yoga', re:/(yoga|ç‘œä¼½)/iu},
  {key:'climb', re:/(climb|boulder|æ”€å²©|æŠ±çŸ³)/iu},
  {key:'cardio', re:/(cardio|æœ‰æ°§)/iu},
  {key:'row', re:/(row(ing)?\b|åˆ’èˆ¹æ©Ÿ)/iu}
];
function detectPartsInLine(line){ const found = new Set(); for(const {key,re} of PART_PATTERNS){ if(re.test(line)) found.add(key); } return found; }

function computeHealthIndex(text){
  const lines = normalizeText(text).split(/\n/);
  const dayMap = new Map();
  let currentDay = null;
  for(const raw of lines){
    const line = raw.trim(); if(!line) continue;
    const mBracket = line.match(/\[(\d{4})-(\d{2})-(\d{2})\]/);
    if(mBracket){ currentDay = `${mBracket[1]}-${mBracket[2]}-${mBracket[3]}`; if(!dayMap.has(currentDay)) dayMap.set(currentDay,{parts:new Set()}); continue; }
    const mHeadDash = line.match(/^\b(\d{4})-(\d{2})-(\d{2})\b/);
    const mHeadSlash = line.match(DATE_SLASH_HEAD);
    if(mHeadDash){ currentDay = `${mHeadDash[1]}-${mHeadDash[2]}-${mHeadDash[3]}`; if(!dayMap.has(currentDay)) dayMap.set(currentDay,{parts:new Set()}); }
    else if(mHeadSlash){ currentDay = `${mHeadSlash[1]}-${pad2(+mHeadSlash[2])}-${pad2(+mHeadSlash[3])}`; if(!dayMap.has(currentDay)) dayMap.set(currentDay,{parts:new Set()}); }
    if(!currentDay) continue;
    const found = detectPartsInLine(line);
    if(found.size){ const rec = dayMap.get(currentDay); for(const k of found) rec.parts.add(k); }
  }
  let dmax = null; for(const d of dayMap.keys()){ const dt=parseYMD(d); if(dt && (!dmax || dt>dmax)) dmax=dt; }
  if(!dmax){ const dates = lines.map(l=>{ const m=l.match(DATE_RE); return m? new Date(+m[1],+m[2]-1,+m[3]) : null; }).filter(Boolean); if(dates.length) dmax = dates.sort((a,b)=>b-a)[0]; }
  if(!dmax) return {score:0,count:0,window:[],dmax:null, detail:[], audit:''};
  const window = []; for(let i=6;i>=0;i--) window.push(ymd(addDays(dmax,-i)));
  let count=0; const detail=[];
  for(const d of window){ const rec = dayMap.get(d); if(!rec){ detail.push({date:d,parts:[],times:0}); continue; }
    const parts=[...rec.parts]; const n = parts.length; const times = n>=2?2:(n>=1?1:0); count += times; detail.push({date:d,parts,times}); }
  const score = Math.min(100, count*10);
  const audit = detail.map(r=>`- ${r.date}ï½œparts=[${r.parts.join(', ')}]ï½œç•¶æ—¥è¨ˆæ¬¡=${r.times}`).join('\n');
  return {score,count,window,dmax,detail,audit};
}

const CATEGORY_DEFS = [
  {key:'å¥åº·æŒ‡æ•¸', kind:'health'},
  {key:'å­¸ç¿’è²¡ç¶“', re:/(?=.*#pomodoro)(?=.*#finance)/i},
  {key:'å­¸ç¿’è‹±æ–‡', re:/(?=.*#pomodoro)(?=.*#english)/i},
  {key:'åæ€æ•´ç†', re:/(?=.*#pomodoro)(?=.*#review)/i},
  {key:'è‡ªæˆ‘è¦ºå¯Ÿ', re:/(?=.*#mentalhealth)(?=.*#selfcontrol)/i},
  {key:'é—œä¿‚ç¶“ç‡Ÿ', re:/(?=.*#relationship)(?=.*#happywifehappylife)/i}
];
function computeCategories(text, healthScore){ const lines = normalizeText(text).split(/\n/).map(s=>s.trim()).filter(Boolean); const counts = new Map(CATEGORY_DEFS.map(c=>[c.key,0])); for(const line of uniq(lines)){ for(const c of CATEGORY_DEFS){ if(c.kind==='health') continue; if(c.re.test(line)) counts.set(c.key, counts.get(c.key)+1); } } const result = CATEGORY_DEFS.map(c=>{ if(c.kind==='health') return {key:c.key, times:Math.round(healthScore/10), score:healthScore}; const times = counts.get(c.key) || 0; return {key:c.key, times, score:Math.min(100, times*10)}; }); return result; }

/*****************
 * Sleep V2 â€” strict format parser
 *****************/
// Example line (anywhere in text):
// [2025-09-28
// 2:42pm ï½œ sleep=9h | onBed=1:00am | energy=8/10 #health]
function parseAmPmToMinutes(t){ const m = t.trim().match(/^(\d{1,2}):(\d{2})\s*(am|pm)$/i); if(!m) return null; let h = (+m[1]) % 12; if(/pm/i.test(m[3])) h += 12; const min = (+m[2]); return h*60 + min; }
function mapBedMinute(m){ if(m==null) return null; if(m < 360) m += 1440; if(m < 1080 && m >= 360) return null; return m; }
function computeSleepV2(text){
  const s = normalizeText(text);
  const recRe = /\[(\d{4})-(\d{2})-(\d{2})[\s\S]*?\n[^\n]*?sleep\s*=\s*([0-9]+(?:\.[0-9]+)?)\s*h[^\n]*?onbed\s*=\s*([0-9]{1,2}:[0-9]{2}\s*(?:am|pm))[^\n]*?energy\s*=\s*([0-9]+(?:\.[0-9]+)?)(?:\s*\/\s*10)?[\s\S]*?\]/gi;
  const rows = []; let m;
  while((m = recRe.exec(s))){
    const d = `${m[1]}-${m[2]}-${m[3]}`;
    const sleepH = parseFloat(m[4]);
    const bedMin0 = parseAmPmToMinutes(m[5]);
    const bedMin = mapBedMinute(bedMin0);
    const eng = parseFloat(m[6]);
    const ok = sleepH>=2 && sleepH<=14 && !isNaN(eng) && eng>=0 && eng<=10 && bedMin!==null;
    rows.push({date:d, sleep:sleepH, bed:bedMin, bedRaw:m[5].trim(), energy:eng, ok});
  }
  if(!rows.length) return {summary:'ï¼ˆæ‰¾ä¸åˆ°ç¬¦åˆæ ¼å¼çš„ç¡çœ ç´€éŒ„ï¼‰', audit:'', hash:''};
  const dmax = rows.map(r=>parseYMD(r.date)).filter(Boolean).sort((a,b)=>b-a)[0];
  const windowSet = new Set(); for(let i=6;i>=0;i--) windowSet.add( ymd(addDays(dmax,-i)) );
  const inWin = rows.filter(r=>windowSet.has(r.date) && r.ok);
  if(!inWin.length){ return {summary:`ï¼ˆæœ€è¿‘ 7 å¤©ç„¡æœ‰æ•ˆç´€éŒ„ã€‚è¦–çª—ï¼š${[...windowSet].join('ã€')}ï¼‰`, audit:'', hash:''}; }
  const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
  const avgSleep = avg(inWin.map(r=>r.sleep));
  const avgBed = avg(inWin.map(r=>r.bed));
  const avgEnergy = avg(inWin.map(r=>r.energy));
  function bedFmt(m){ if(m==null) return 'â€”'; if(m>=1440) m -= 1440; let h = Math.floor(m/60), mm = m%60; const ap = h>=12 ? 'pm' : 'am'; h = h%12; if(h===0) h=12; return `${h}:${String(mm).padStart(2,'0')}${ap}`; }
  const summary = `ğŸ§¾ ç¡çœ ä¸€é€±å¹³å‡ï¼ˆè¦–çª—ï¼š${[...windowSet].join('ã€')}ï¼‰\n- å¹³å‡ç¡çœ æ™‚é–“ï¼š${avgSleep.toFixed(2)} h\n- å¹³å‡ on-bed æ™‚é–“ï¼š${bedFmt(avgBed)}\n- å¹³å‡ç²¾ç¥ energyï¼š${avgEnergy.toFixed(2)} / 10`;
  const audit = inWin.map(r=>`- ${r.date}ï½œsleep=${r.sleep}hï½œonBed=${r.bedRaw}ï½œenergy=${r.energy}/10`).join('\n');
  const hash = hashString(summary+'|'+audit);
  return {summary, audit, hash};
}

/*****************
 * Rendering
 *****************/
function renderFixedTable(rows){
  const map = new Map(rows.map(r=>[r.key,r]));
  function rowHTML(k){ const r = map.get(k) || {times:0,score:0}; return `<tr><td>${k}</td><td>${r.times} æ¬¡</td><td>${r.score} åˆ†</td></tr>`; }
  const html = `
  <table>
    <thead>
      <tr><th>é¡åˆ¥</th><th>å‡ºç¾æ¬¡æ•¸</th><th>ç¸½åˆ†</th></tr>
    </thead>
    <tbody>
      ${rowHTML('å¥åº·æŒ‡æ•¸')}
      ${rowHTML('å­¸ç¿’è²¡ç¶“')}
      ${rowHTML('å­¸ç¿’è‹±æ–‡')}
      ${rowHTML('åæ€æ•´ç†')}
      ${rowHTML('è‡ªæˆ‘è¦ºå¯Ÿ')}
      ${rowHTML('é—œä¿‚ç¶“ç‡Ÿ')}
    </tbody>
  </table>`;
  return html;
}

function doAll(){
  const rawAll = $('#inputText').value||'';
  const healthRaw = (typeof EXERCISE_TEXT==='string' && EXERCISE_TEXT.length) ? EXERCISE_TEXT : (document.querySelector('#inputTextPage2')?.value || '');

  const health = computeHealthIndex(healthRaw);
  const categories = computeCategories(rawAll, health.score);
  const tableHTML = renderFixedTable(categories);
  const sourceNote = healthRaw.trim()? 'ï¼ˆè³‡æ–™ä¾†æºï¼šPage 2 é‹å‹•è¼¸å…¥ï¼‰' : 'ï¼ˆâš  æœªå¡« Page 2ï¼Œå¥åº·æŒ‡æ•¸å°‡ç‚º 0ï¼‰';
  $('#scoreTableWrap').innerHTML = tableHTML + `<div style="margin-top:8px" class="muted">å¥åº·æŒ‡æ•¸ï¼šæœ€è¿‘ä¸ƒå¤©ï¼ˆ${health.window.join('ã€')}ï¼‰å…± <b>${health.count}</b> æ¬¡é‹å‹• â†’ ${health.score} åˆ†ã€‚` + (health.dmax?`ï¼ˆDmax=${ymd(health.dmax)}ï¼‰`:'') + ` ${sourceNote}</div>`;
  $('#exerciseAudit').textContent = health.audit || 'ï¼ˆç„¡è³‡æ–™å¯åˆ—ï¼‰';

  // Sleep V2
  const sleep = computeSleepV2(rawAll);
  const sSum = document.getElementById('sleepV2Summary');
  const sAud = document.getElementById('sleepV2Audit');
  if(sSum && sAud){ sSum.textContent = sleep.summary; sAud.textContent = sleep.audit; }

  const fp = makeFingerprint(rawAll + '\n\n__EXERCISE__\n' + healthRaw);
  const cur = {L:fp.L,C:fp.C,H:fp.H, tableHash:hashString(tableHTML)};
  let alertMsg = '';
  if(lastFingerprint && lastFingerprint.L===cur.L && lastFingerprint.C===cur.C && lastFingerprint.H===cur.H){ if(lastFingerprint.tableHash!==cur.tableHash){ alertMsg = 'âš ï¸ åµæ¸¬åˆ°çµæœä¸ä¸€è‡´ï¼šè«‹æª¢æŸ¥æ˜¯å¦æœ‰åˆ¤æ–·é‚è¼¯æˆ–çµ±è¨ˆç•°å‹•ï¼Œæˆ–æ¨™è¨˜é †åºå°è‡´éºæ¼ã€‚'; } }
  lastFingerprint = cur;
  $('#alertBox').textContent = alertMsg;
}

/*****************
 * Tests (sleep tests omitted here)
 *****************/
function runTests(){
  const out=[]; const ok = (name, cond, left, right)=> out.push(`${cond? 'âœ…':'âŒ'} ${name}${cond?'':`\n   got: ${left}\n   expected: ${right}`}`);
  const t1 = `
[2025-09-20]
2025-09-20ï½œchest smith press
2025-09-20ï½œswim 1km
[2025-09-26]
2025-09-26ï½œwalk 7k steps`;
  const h1 = computeHealthIndex(t1);
  ok('T1 count==3', h1.count===3, h1.count, 3);
  ok('T1 score==30', h1.score===30, h1.score, 30);
  ok('T1 dmax==2025-09-26', (h1.dmax && ymd(h1.dmax)==='2025-09-26'), h1.dmax && ymd(h1.dmax), '2025-09-26');
  document.getElementById('testOut').textContent = out.join('\n');
}

/*****************
 * Events
 *****************/
$('#next1').addEventListener('click',()=>{ if(!$('#inputText').value.trim()){ alert('è«‹å…ˆè²¼ä¸Šè³‡æ–™'); return; } setStep(2); });
$('#back1').addEventListener('click',()=>setStep(1));
$('#back2').addEventListener('click',()=>{ setStep(2); const p2=$('#inputTextPage2'); if(p2) p2.value=''; });

let EXERCISE_TEXT='';
function appendFromPage2(){ const el = document.querySelector('#inputTextPage2'); if(!el) return; const v = el.value.trim(); EXERCISE_TEXT = v; }
$('#confirmHasWorkout').addEventListener('click',()=>{ appendFromPage2(); setStep(3); doAll(); });
$('#confirmNoWorkout').addEventListener('click',()=>{ appendFromPage2(); setStep(3); doAll(); });

$('#recalc').addEventListener('click',()=>doAll());
$('#copyTable').addEventListener('click',()=>{ const node = $('#scoreTableWrap'); const txt = node.innerText.replace(/\n{2,}/g,'\n'); navigator.clipboard.writeText(txt).then(()=>{ alert('å·²è¤‡è£½è©•åˆ†è¡¨è‡³å‰ªè²¼ç°¿'); }); });
$('#copySleepV2').addEventListener('click',()=>{ const block = (document.getElementById('sleepV2Summary')?.innerText||'') + '\n\n' + (document.getElementById('sleepV2Audit')?.innerText||''); navigator.clipboard.writeText(block).then(()=>alert('å·²è¤‡è£½ç¡çœ å€å¡Š')); });
$('#clear').addEventListener('click',()=>{ $('#inputText').value=''; const p2=$('#inputTextPage2'); if(p2) p2.value=''; EXERCISE_TEXT=''; lastFingerprint=null; $('#scoreTableWrap').innerHTML=''; $('#exerciseAudit').textContent=''; $('#testOut').textContent=''; document.getElementById('sleepV2Summary').textContent=''; document.getElementById('sleepV2Audit').textContent=''; });
$('#demo').addEventListener('click',()=>{
  const demo = `
[2025-09-20]
2025-09-20ï½œ#pomodoro #financeï½œé–±è®€ã€Šæ¼«æ­¥è¯çˆ¾è¡—ã€‹30m
2025-09-20ï½œchest smith press 90kg x 10

[2025-09-21]
2025-09-21ï½œ#pomodoro #englishï½œshadowing 20m
2025-09-21ï½œswim 1km

[2025-09-22]
[2025-09-22\n11:55pm ï½œ sleep=6.2h | onBed=11:40pm | energy=6/10 #health]

[2025-09-23]
2025-09-23ï½œrun 5k
[2025-09-23\n12:05am ï½œ sleep=6.0h | onBed=12:05am | energy=5/10 #health]

[2025-09-24]
[2025-09-24\n12:10am ï½œ sleep=7.2h | onBed=12:10am | energy=7/10 #health]

[2025-09-25]
2025-09-25ï½œwalk 7k steps

[2025-09-26]
[2025-09-26\n12:05am ï½œ sleep=6h | onBed=12:05am | energy=5/10 #health]
`;
  $('#inputText').value = demo.trim();
});

const runBtn = document.querySelector('#runTests');
if(runBtn) runBtn.addEventListener('click', runTests);

// default to Page 1
setStep(1);
</script>
</body>
</html>
